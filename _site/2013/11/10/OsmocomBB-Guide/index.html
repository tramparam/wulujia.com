<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>OSMOCOMBB新手指南 - NOTEPAD</title>
  <meta name="description" content="NOTEPAD - 信息安全, DLP, 敏感信息防泄漏, 移动互联网, 创业">
  <meta name="author" content="wulujia">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:300,400' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/disqus.css">

  <script src="/js/libs/modernizr-2.0.6.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
</head>

<body>
  <div id="container">

    <header>
  <h1><a class="fadedlink" href="/" title="首页">&laquo;</a> OSMOCOMBB新手指南 <small>2013-11-10</small></h1>

  <nav>
    <ul class="clearfix">
    
      <a href="/tag/security.html">security <span class="badge">8</span></a>
    
      <a href="/tag/mobile.html">mobile <span class="badge">6</span></a>
    
      <a href="/tag/gsm.html">gsm <span class="badge">3</span></a>
    
      <a href="/tag/osmocombb.html">osmocombb <span class="badge">9</span></a>
    
    </ul>
  </nav>
</header>

<script>
// https://github.com/ghiculescu/jekyll-table-of-contents
$(document).ready(function() {
  var no_back_to_top_links = false

  var headers = $('h1, h2, h3, h4, h5, h6').filter(function() {return this.id}), // get all headers with an ID
      output = $('.toc');
  if (!headers.length || headers.length < 3 || !output.length)
    return;

  var get_level = function(ele) { return parseInt(ele.nodeName.replace("H", ""), 10) }
  var highest_level = headers.map(function(_, ele) { return get_level(ele) }).get().sort()[0]
  // var return_to_top = '<i class="icon-arrow-up back-to-top"> ^ </i>'
  var return_to_top = ''

  var level = get_level(headers[0]), this_level, html = "<i></i> <ol>";
  headers.on('click', function() {
    if (!no_back_to_top_links) window.location.hash = this.id
  }).addClass('clickable-header').each(function(_, header) {
    this_level = get_level(header);
    if (!no_back_to_top_links && this_level === highest_level) {
      $(header).addClass('top-level-header').after(return_to_top)
    }
    if (this_level === level) // same level as before; same indenting
      html += "<li><a href='#" + header.id + "'>" + header.innerHTML + "</a>";
    else if (this_level < level) // higher level than before; end parent ol
      html += "</li></ol></li><li><a href='#" + header.id + "'>" + header.innerHTML + "</a>";
    else if (this_level > level) // lower level than before; expand the previous to contain a ol
      html += "<ol><li><a href='#" + header.id + "'>" + header.innerHTML + "</a>";
    level = this_level; // update for the next one
  });
  html += "</ol>";
  if (!no_back_to_top_links) {
    $(document).on('click', '.back-to-top', function() {
      $(window).scrollTop(0)
      window.location.hash = ''
    })
  }
  output.hide().html(html).show('slow');
});
</script>
<div class="toc"></div>

<hr/>

<div id="post" role="main">
  <p>很多人可能知道，GSM通讯是可以被监听的。不过，我猜测，知道下面这几点的可能不多：</p>

<ul>
<li>廉价的监听设备只需要数十元成本；</li>
<li>所需要的技能只是懂英语，会编译Linux程序；</li>
<li>至少在2010年，技术已经成熟，2011年有开源实现。</li>
</ul>

<hr>

<h1 id="toc_0">基础</h1>

<p>OSMOCOM-bb全称Open source mobile communication Baseband，是GSM协议栈的开源实现。开发团队的介绍文字是：</p>

<blockquote>
<p>OsmocomBB is an Free Software / Open Source GSM Baseband software implementation. It intends to completely replace the need for a proprietary GSM baseband software, such as</p>

<ul>
<li>drivers for the GSM analog and digital baseband (integrated and external) peripherals </li>
<li>the GSM phone-side protocol stack, from layer 1 up to layer 3</li>
</ul>

<p>In short: By using OsmocomBB on a compatible phone, you are able to make and receive phone calls, send and receive SMS, etc. based on Free Software only.</p>
</blockquote>

<h2 id="toc_1">关于加密</h2>

<p>GSM加密采用A5算法。A5算法1989年由法国人开发，是一种序列密码，它是欧洲GSM标准中规定的加密算法，专用于数字蜂窝移动电话的加密，用于对从电话到基站连接的加密。A5的特点是效率高，适合硬件上高效实现。</p>

<p>A5发展至今，有A5/1、A5/2、A5/3、A5/4、A5/5、A5/6、A5/7等7个版本，目前GSM终端一般都支持A5/1和A5/3，A5/4以上基本不涉及。值得注意的是，A5/2是被『故意弱化强度』的版本，专用于『出口』给『友邦』，2006年后被强制叫停，终端不允许支持A5/2。</p>

<p>A5/1与A5/2两个算法的设计后来被Marc Briceno、Ian Goldberg和David Wagner用逆向工程破解，下图是当年用于破解的设备：</p>

<p><img src="/img/posts/osmocombb-guide/gsmclone.jpg" alt="当年用于破解的设备" style="width: 30%; height: 30%"/></p>

<p>国内的GSM采用了什么算法呢……嗯……你试试就知道了……</p>

<h2 id="toc_2">一些名词</h2>

<ul>
<li>MS：Mobile Station，移动终端；</li>
<li>IMSI：International Mobile Subscriber Identity，国际移动用户标识号，是TD系统分给用户的唯一标识号，它存储在SIM卡、HLR/VLR中，最多由15个数字组成；</li>
<li>MCC：Mobile Country Code，是移动用户的国家号，中国是460；</li>
<li>MNC：Mobile Network Code ，是移动用户的所属PLMN网号，中国移动为00、02，中国联通为01；</li>
<li>MSIN：Mobile Subscriber Identification Number，是移动用户标识；</li>
<li>NMSI：National Mobile Subscriber Identification，是在某一国家内MS唯一的识别码；</li>
<li>BTS：Base Transceiver Station，基站收发器；</li>
<li>BSC：Base Station Controller，基站控制器；</li>
<li>MSC：Mobile Switching Center，移动交换中心。移动网络完成呼叫连接、过区切换控制、无线信道管理等功能的设备，同时也是移动网与公用电话交换网(PSTN)、综合业务数字网(ISDN)等固定网的接口设备；</li>
<li>HLR：Home location register。保存用户的基本信息，如你的SIM的卡号、手机号码、签约信息等，和动态信息，如当前的位置、是否已经关机等；</li>
<li>VLR：Visiting location register，保存的是用户的动态信息和状态信息，以及从HLR下载的用户的签约信息；</li>
<li>CCCH：Common Control CHannel，公共控制信道。是一种“一点对多点”的双向控制信道，其用途是在呼叫接续阶段，传输链路连接所需要的控制信令与信息。</li>
</ul>

<h2 id="toc_3">手机开机时的位置更新过程</h2>

<ol>
<li>MS（手机）向系统请求分配信令信道（SDCCH）；</li>
<li>MSC收到手机发来的IMSI可及消息；</li>
<li>MSC将IMSI可及信息再发送给VLR，VLR将IMSI不可及标记更新为IMSI可及；</li>
<li>VLR反馈MSC可及信息信号；</li>
<li>MSC再将反馈信号发给手机。</li>
</ol>

<p>MS倾向信号强的BTS，使用哪种算法由基站决定，这也导致了可以用伪基站进行攻击。</p>

<hr>

<h1 id="toc_4">使用方法演示</h1>

<p>用法很简单：</p>

<ul>
<li>将firmware刷入手机</li>
</ul>

<p><img src="/img/posts/osmocombb-guide/mobile1.png" alt="将firmware刷入手机" style="width: 70%; height: 70%"/></p>

<ul>
<li>扫描基站</li>
</ul>

<p><img src="/img/posts/osmocombb-guide/mobile2.png" alt="扫描基站" style="width: 70%; height: 70%"/></p>

<ul>
<li>选择想要监听的基站并开始监听数据</li>
</ul>

<p><img src="/img/posts/osmocombb-guide/mobile3.png" alt="开始监听" style="width: 70%; height: 70%"/></p>

<ul>
<li>将监听数据写入本地cap包</li>
</ul>

<p><img src="/img/posts/osmocombb-guide/mobile4.png" alt="写入本地cap包" style="width: 70%; height: 70%"/></p>

<ul>
<li>通过过滤程序过滤出监听到的短信（理论上话音一样能够被监听及解码，只是涉及技术更为复杂）</li>
</ul>

<p><img src="/img/posts/osmocombb-guide/mobile5.png" alt="过滤出监听到的短信" style="width: 70%; height: 70%"/></p>

<hr>

<h1 id="toc_5">具体编译方法</h1>

<h2 id="toc_6">预备</h2>

<p>这里我使用的Linux环境为ubuntu 12.04 x86（交叉环境不支持64位系统），其他系统方法一样，命令会有些差别，请自行分辨。</p>

<ol>
<li><p>预备</p>

<p>apt-get install build-essential g++ gcc make automake libtool libusb-dev pkg-config git wireshark tshark</p></li>
<li><p>安装libosmocore</p>

<p>git clone git://git.osmocom.org/libosmocore.git<br>
cd libosmocore/<br>
autoreconf -i<br>
./configure<br>
make<br>
sudo make install  </p></li>
</ol>

<h2 id="toc_7">编译</h2>

<ul>
<li><p>编译osmocom-bb.git，细节可以参考<a href="https://srlabs.de/gsm-map-tutorial/">https://srlabs.de/gsm-map-tutorial/</a></p>

<ul>
<li><p>下载代码到~/cell_logger</p>

<p>mkdir -p ~/cell_logger<br>
cd ~/cell_logger<br>
git clone git://git.osmocom.org/osmocom-bb.git</p></li>
<li><p>下载ARM交叉编译环境</p>

<p>wget <a href="http://gnuarm.com/bu-2.15_gcc-3.4.3-c-c++-java_nl-1.12.0_gi-6.1.tar.bz2">http://gnuarm.com/bu-2.15_gcc-3.4.3-c-c++-java_nl-1.12.0_gi-6.1.tar.bz2</a><br>
tar xf bu-2.15_gcc-3.4.3-c-c++-java_nl-1.12.0_gi-6.1.tar.bz2  </p></li>
<li><p>准备OsmocomBB&#39;s burst_ind branch</p>

<p>cd ~/cell_logger/osmocom-bb<br>
git checkout --track origin/luca/gsmmap  </p></li>
<li><p>编译OsmocomBB</p>

<p>cd src<br>
export PATH=$PATH:~/cell_logger/gnuarm-3.4.3/bin<br>
make</p></li>
</ul></li>
</ul>

<h2 id="toc_8">执行</h2>

<ul>
<li><p>连接手机，刷入firmware，不同设备需要刷入不同的firmware，这里的例子是针对Motorola C118的</p>

<p>sudo ~/cell_logger/osmocom-bb/src/host/osmocon/osmocon -m c123xor -p /dev/ttyUSB0 ~/cell_logger/osmocom-bb/src/target/firmware/board/compal_e88/layer1.compalram.bin</p></li>
<li><p>按一下手机开机键开机，确认进入osmocom-bb系统</p></li>
<li><p>扫描基站</p>

<p>sudo ~/cell_logger/osmocom-bb/src/host/layer23/src/misc/cell_log -O</p></li>
<li><p>监听某基站，例如31</p>

<p>~/cell_logger/osmocom-bb/src/host/layer23/src/misc/ccch_scan -i 127.0.0.1 -a 31</p></li>
<li><p>保存日志</p>

<p>dumpcap -i lo -w ~/cell_logger/mobilelog/a.log</p></li>
<li><p>可以用wireshark或tshark打开日志，过滤出相应协议字段，就能读出短信了。SMS协议字段参考tshark -G fields | grep gsm_sms</p></li>
</ul>

<hr>

<h1 id="toc_9">其他</h1>

<h2 id="toc_10">接多个手机</h2>

<p>ccch_scan只是一个例子程序，用它并不能连接多个手机通讯——有人提出过同样的疑问，可以参考<a href="http://comments.gmane.org/gmane.comp.mobile.osmocom.baseband.devel/2627">链接1</a>和<a href="http://baseband-devel.722152.n3.nabble.com/About-sniff-multi-bursts-in-a-frame-CCCH-CONF-td3368272.html">链接2</a>。</p>

<p>需要使用Sylvain Munaut的DSP Patch版本，git地址在：<a href="http://cgit.osmocom.org/osmocom-bb/?h=sylvain%2Fburst_ind">http://cgit.osmocom.org/osmocom-bb/?h=sylvain%2Fburst_ind</a>。</p>

<p>图：8台手机基本能够覆盖一个区域的基站。所以，有人在干活（感谢TK提供图片并对我玩OsmocomBB的指点）。</p>

<p><img src="/img/posts/osmocombb-guide/mobile6.png" alt="同时接8台手机监听" style="width: 50%; height: 50%"/></p>

<h2 id="toc_11">上行捕获</h2>

<p>参考链接：<a href="http://bb.osmocom.org/trac/wiki/Hardware/FilterReplacement">http://bb.osmocom.org/trac/wiki/Hardware/FilterReplacement</a></p>

<p>要使手机能够成为『passive uplink sniffer』，必须动到电烙铁，替换掉RX filters。</p>

<p>替换前：</p>

<p><img src="/img/posts/osmocombb-guide/motorola_filter_replacement_step_1_low.jpg" alt="替换前" style="width: 50%; height: 50%"/></p>

<p>摘掉后：</p>

<p><img src="/img/posts/osmocombb-guide/motorola_filter_replacement_step_2_low.jpg" alt="摘掉后" style="width: 50%; height: 50%"/></p>

<p>替换后：</p>

<p><img src="/img/posts/osmocombb-guide/motorola_filter_replacement_step_7_low.jpg" alt="替换后" style="width: 50%; height: 50%"/></p>

<h2 id="toc_12">Some Tips</h2>

<ol>
<li>开机键不是长按，而是短按，否则就进入原系统了；</li>
<li>CP210x的接线，RX和TX有可能需要对调；</li>
<li>交叉编译要在i386系统，否则make的时候会“gnuarm-3.4.3/bin/arm-elf-gcc: No such file or directory”；</li>
<li>检查连线是否正常，可以参考：<a href="http://bb.osmocom.org/trac/wiki/Hardware/CP210xTutorial">CP210x Tutorial</a>，运行cp210x-program需要先安装ibusb-dev，如果输出是“No devices found”或“Unable to send request, 3709 result=-110”，则有问题。</li>
</ol>

<hr>

<h1 id="toc_13">坏人能用类似的技术做什么</h1>

<h2 id="toc_14">替用户订阅SP服务</h2>

<p>2007年，用户投诉都被盗打了XXX信息台和发送短信至XXX（手机钱包话费支付业务）的情况，且用户都统一被收取了该声讯台的包月费30元，通过话单梳理，全地区在该时间段内（从12月1日至10日）共有8000多用户被收取了包月费，根据业务支撑部门的统计，已超过了过该业务的正常业务量数倍多，属于不正常现象。</p>

<p>这个案例是@tombkeeper在TSRC演讲的时候提到，我后来找他学习细节时知道的，可以参考链接<a href="http://www.leaffly.com/post/steal_calls_for_game.html">盗打购买游戏点卡的分析</a>。在2007年，就有人用这样的『高科技手段』挣钱，黑产真是不能小看。</p>

<h2 id="toc_15">群发垃圾广告</h2>

<p>贴两张图，信息量应该就够大了。</p>

<p><img src="/img/posts/osmocombb-guide/mobile_spam.png" alt="垃圾短信" style="width: 50%; height: 50%"/></p>

<p><img src="/img/posts/osmocombb-guide/gnuradio.png" alt="短信群发工具" style="width: 50%; height: 50%"/></p>

<h2 id="toc_16">社工与窃密</h2>

<p>既然能够伪造短信，试想一下，如果有人：</p>

<ul>
<li>伪造贵厂厂长的电话给你发短信，索取某项目细节信息</li>
<li>在竞标、投标前期和现场伪造短信传递决策信息</li>
</ul>

<h2 id="toc_17">其他</h2>

<ul>
<li>短信、语音、gprs都是可窃听的，只是技术难度不同</li>
<li>目前在工业控制系统中还大量使用GSM通信自动传输信息</li>
</ul>

<p>攻击取决于攻击者的想象力，黑产从业者永远更缺乏安全感，绝大多数时候更搏命、更努力创新。企业安全的守门员门，站稳喽，你守得住吗？</p>

<hr>

<h1 id="toc_18">录像</h1>

<p>有个录像还是能看得比较清楚的：</p>

<p><a href="http://v.qq.com/boke/page/e/4/b/e0118d61u4b.html">http://v.qq.com/boke/page/e/4/b/e0118d61u4b.html</a></p>

<hr>

<h1 id="toc_19">参考链接</h1>

<ul>
<li>OsmocomBB项目官网：<a href="http://bb.osmocom.org">http://bb.osmocom.org</a></li>
<li>Osmocom-bb git：<a href="http://cgit.osmocom.org/osmocom-bb/">http://cgit.osmocom.org/osmocom-bb/</a></li>
<li>RadioWar Wiki（中文）：<a href="http://wiki.radiowar.org/">http://wiki.radiowar.org/</a></li>
<li>GSM Security：<a href="http://www.gsm-security.net/">http://www.gsm-security.net/</a></li>
<li>A5/1破解：<a href="http://mtlin.org/article/a51.html">http://mtlin.org/article/a51.html</a></li>
<li>IMSI catcher：<a href="https://opensource.srlabs.de/projects/catcher/wiki">https://opensource.srlabs.de/projects/catcher/wiki</a></li>
</ul>

  <p class="back">&laquo; <a href="/">首页</a></p>
</div>

<h2>相关</h2>
<ul class="posts_list">
  
    <li class="post">
  <span class="date">2014-01-03</span>
  <a href="/2014/01/03/operation" title="互联网产品的「运营」">互联网产品的「运营」</a>
</li>
  
    <li class="post">
  <span class="date">2014-01-01</span>
  <a href="/2014/01/01/security-app-trustgo" title="手机安全APP：Trustgo">手机安全APP：Trustgo</a>
</li>
  
    <li class="post">
  <span class="date">2014-01-01</span>
  <a href="/2014/01/01/security-app-nq" title="手机安全APP：网秦">手机安全APP：网秦</a>
</li>
  
</ul>

<hr/>

<h2>留言</h2>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'wulujia'; // required: replace example with your forum shortname
    //var disqus_developer = 1; // developer mode is on, for testing locally

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


    <footer>
      <span>wulujia </span>
      <a class="fadedlink" href="mailto:wulujia@gmail.com"><img src="/img/gmail-logo.png" alt="@gmail"></a>
    </footer>
  </div>

  <!--[if lt IE 7 ]>
    <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
    <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->
</body>
</html>
